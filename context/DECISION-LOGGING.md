# Decision Logging Contract

This repo uses an append-only decision log as the persistent “context graph”:

- Active File: `context/decisions_active.jsonl`
- Graveyard File: `context/decisions_graveyard.jsonl` (archived/deleted decisions)
- Format: JSON Lines (one JSON object per line)
- Rule: NEVER edit old lines. Only append new lines.

## When to log
Log a decision when it constrains future behavior, including:
- user approvals / rejections
- agent or main assistant autonomous decisions
- implicit approvals (user says “ok/yes” or proceeds)

Do NOT log purely mechanical edits (formatting, renames) unless it creates a reusable constraint/pattern.

## Who can log
Any agent (or the main assistant) may log decisions, but MUST do it via the Python script:

- Script: `scripts/decision_log.py`

No one should hand-edit `context/decisions_active.jsonl` or `context/decisions_graveyard.jsonl`.

## Required fields (top-level)
Each entry MUST include:
- id (generated by script): "DEC-0001"
- ts (generated by script): ISO-8601 with timezone
- actor: one of
  - "user"
  - "workflow-orchestrator"
  - "main-assistant"
  - any concrete agent name (e.g., "test-planner")
- status: "proposed" | "approved" | "rejected"
- decision: one sentence describing the decision
- context: object with required keys:
  - workflow: "Small Changes" | "Large Changes" | "Iteration Loop" | "meta"
  - step: e.g., "Step 1", "Step 5", "PR Review"
  - reason: why this decision was made
  - refs: array of references (may be empty)

Optional keys inside context:
- options: array of options considered
- chosen: chosen option
- supersedes: array of prior decision IDs this replaces

## How to log (command)
Always use the script:

### Minimal
python3 scripts/decision_log.py add \
  --actor "test-planner" \
  --status "proposed" \
  --decision "Add regression test for null config value" \
  --workflow "Large Changes" \
  --step "Step 5" \
  --reason "Spec requires coverage for config parsing edge cases"

### With refs/options/chosen/supersedes
python3 scripts/decision_log.py add \
  --actor "user" \
  --status "approved" \
  --decision "Use ranking-time filtering" \
  --workflow "Large Changes" \
  --step "Step 1" \
  --reason "Keeps ingestion simple and preserves flexibility" \
  --refs "file:ranking/filter.ts" "spec:visa-filtering" \
  --options "ingestion-time" "ranking-time" \
  --chosen "ranking-time" \
  --supersedes "DEC-0014"

## Reading decisions
Agents should read the last ~50 lines when looking for recent decisions, and search by `id` when referenced.

## Hard Stop Rule
Decision logging is a HARD STOP invariant.

If a qualifying decision is made or proposed and the decision cannot be
successfully appended to `context/decisions_active.jsonl` via
`python3 scripts/decision_log.py`, the agent MUST:

1. STOP immediately
2. Report the failure and reason (exception / error output)
3. Ask for guidance before proceeding

Continuing execution after a logging failure is a workflow violation.

## Querying & Using Decisions (Hard Rule)

Before proposing or making any decision that constrains future behavior, agents MUST
query the decision log via `scripts/decision_log.py` and incorporate relevant prior decisions.

Required minimum behavior:
1) `python3 scripts/decision_log.py search --q "<keywords>" --n 20`
2) If the topic is likely recent or ongoing, also:
   `python3 scripts/decision_log.py latest --n 30`

If a relevant prior decision is found:
- Cite the decision ID(s) explicitly in the output
- Follow approved decisions
- Do not re-propose rejected decisions
- If conflicts exist between decisions vs Spec Packet vs design docs, STOP and escalate

Hard stop:
If querying fails (non-zero exit, missing file, parse failure that prevents results),
STOP and report the error. Do not proceed.
